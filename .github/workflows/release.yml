name: Release

on:
  push:
    tags:
      - "v*"

# Prevent double-publish races for the same tag
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  release:
    runs-on: ubuntu-latest
    environment: release

    env:
      MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      # -----------------------------
      # Version validation (HARD GATE)
      # -----------------------------
      - name: Validate release version
        id: version_check
        shell: bash
        run: |
          set -euo pipefail

          TAG_VERSION="${GITHUB_REF_NAME#v}"
          echo "Tag version: $TAG_VERSION"
          echo "Releasing commit: $GITHUB_SHA"

          POM_VERSION="$(mvn -q -Dexec.executable=echo \
            -Dexec.args='${project.version}' \
            --non-recursive \
            org.codehaus.mojo:exec-maven-plugin:3.1.0:exec)"

          echo "POM version: $POM_VERSION"

          if [[ "$POM_VERSION" == *"-SNAPSHOT" ]]; then
            echo "❌ Refusing to release a SNAPSHOT version"
            exit 1
          fi

          if [[ "$TAG_VERSION" != "$POM_VERSION" ]]; then
            echo "❌ Tag version ($TAG_VERSION) does not match POM version ($POM_VERSION)"
            exit 1
          fi

          echo "✅ Version check passed"

      - name: Write Maven settings.xml
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<'EOF'
          <settings>
            <servers>
              <server>
                <id>central</id>
                <username>${{ secrets.CENTRAL_USERNAME }}</username>
                <password>${{ secrets.CENTRAL_PASSWORD }}</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: Configure GPG for non-interactive signing
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg

          cat > ~/.gnupg/gpg.conf <<'EOF'
          batch
          no-tty
          pinentry-mode loopback
          EOF

          cat > ~/.gnupg/gpg-agent.conf <<'EOF'
          allow-loopback-pinentry
          EOF

          gpgconf --kill gpg-agent || true
          gpgconf --launch gpg-agent

      - name: Import GPG key
        shell: bash
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          set -euo pipefail

          if [[ -z "${GPG_PRIVATE_KEY:-}" ]]; then
            echo "❌ GPG_PRIVATE_KEY secret is empty"
            exit 1
          fi

          echo "$GPG_PRIVATE_KEY" | gpg --batch --yes --import

          KEY_FPR="$(gpg --list-secret-keys --with-colons | awk -F: '/^fpr:/ {print $10; exit}')"
          if [[ -z "${KEY_FPR:-}" ]]; then
            echo "❌ No secret key fingerprint found after import"
            gpg --list-secret-keys || true
            exit 1
          fi

          echo "Imported signing key: ${KEY_FPR}"

          # Mark key as ultimately trusted for non-interactive signing
          echo "${KEY_FPR}:6:" | gpg --batch --import-ownertrust

      - name: Build and test (preflight)
        shell: bash
        run: |
          set -euo pipefail
          mvn -B -q -Prelease verify

      - name: Release to Maven Central
        shell: bash
        run: |
          set -euo pipefail
          mvn -Prelease -B -e \
            -Dgpg.passphrase="${MAVEN_GPG_PASSPHRASE}" \
            -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn \
            clean deploy
